<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⭐</text></svg>" />
<title>⭐ Bot rating widget</title>

<!-- Минимальная стилизация -->
<style>
  :root { font-family: system-ui, sans-serif; }
  body   { margin: 0; padding: 8px; background: transparent; }
  h3     { margin: 0 0 8px; font-size: 14px; color: #666; }
  #stars { display: flex; gap: 4px; font-size: 24px; cursor: pointer; }
  .star  { color: #ccc; transition: color .2s; user-select: none; }
  .star.active { color: #f5b301; }
</style>
</head>
<body>

<h3>Оцените ответ бота</h3>
<div id="stars">
  <span class="star" data-v="1">☆</span><span class="star" data-v="2">☆</span>
  <span class="star" data-v="3">☆</span><span class="star" data-v="4">☆</span>
  <span class="star" data-v="5">☆</span>
</div>

<!-- ⬇⬇   ЗАГРУЗКА MATRIX WIDGET API   ⬇⬇ -->
<script src="api.min.js"></script>

<!-- ⬇⬇   ВЕСЬ JS   ⬇⬇ -->
<script>
/*
 * Используем UMD версию matrix-widget-api для работы без бандлера
 * После загрузки скрипта API доступен под mxwidgets
 */

/* ----------------- НАСТРОЙКИ ----------------- */
// Дожидаемся загрузки DOM и инициализируем API
document.addEventListener('DOMContentLoaded', () => {
  // mxwidgets является функцией, нужно её вызвать для получения экспортов
  const widgetApi = mxwidgets();
  
  // Инициализируем API
  const api = new widgetApi.WidgetApi();

  /* event_id передаётся параметром ?event_id=$abc... */
  const target = new URLSearchParams(location.search).get('event_id') ?? undefined;

  /* Запускаем API */
  api.start();

  /* Уведомляем клиент, что виджет готов */
  try {
    api.sendContentLoaded();
  } catch (e) {
    console.log('Локальное тестирование - sendContentLoaded не требуется');
  }

  /* Запрашиваем нужные права, но НЕ ждём — UI должен работать сразу */
  try {
    api.requestCapabilities([
      'org.matrix.msc2762.send_event.m.reaction',
      'org.matrix.msc2762.receive_event',
    ]);
  } catch (e) {
    console.log('Локальное тестирование - capabilities не требуются');
  }

  /* ----------------- UI: звёзды ----------------- */
  const stars  = [...document.querySelectorAll('.star')];
  let   chosen = 0;

  const paint = () => stars.forEach(el => {
    const v = +el.dataset.v;
    el.textContent = v <= chosen ? '★' : '☆';
    el.classList.toggle('active', v <= chosen);
  });

  const send = async v => {
    chosen = v; paint();
    if (!target) return;                            // нет event_id → локальный режим
    try {
      await api.sendEvent('m.reaction', {
        'm.relates_to': {
          rel_type : 'm.annotation',
          event_id : target,
          key      : `rating:${v}`,
        },
      });
    } catch (e) { console.error(e); }
  };

  /* клики по звёздам */
  stars.forEach(el => el.addEventListener('click', () => send(+el.dataset.v)));

  /* при перезагрузке выясняем, какую звезду мы уже ставили */
  // Упрощённая версия - пока не используем получение существующих реакций
  if (target) {
    console.log('Widget готов для работы с событием:', target);
  }

  paint();        // первичная отрисовка
});
</script>

</body>
</html>
