{"ast":null,"code":"import React,{useState,useCallback,useEffect}from'react';import{WidgetApi}from'matrix-widget-api';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const RatingWidget=()=>{const[rating,setRating]=useState(0);const[hoverRating,setHoverRating]=useState(0);const[feedback,setFeedback]=useState('');const[isSubmitting,setIsSubmitting]=useState(false);const[widgetApi,setWidgetApi]=useState(null);// Инициализируем Widget API\nuseEffect(()=>{const api=new WidgetApi();api.start();try{api.sendContentLoaded();}catch(e){console.log('Локальное тестирование - sendContentLoaded не требуется');}try{api.requestCapabilities(['org.matrix.msc2762.send_event.m.reaction','org.matrix.msc2762.receive_event']);}catch(e){console.log('Локальное тестирование - capabilities не требуются');}setWidgetApi(api);},[]);// Получаем event_id из URL параметров\nconst getEventId=useCallback(()=>{const urlParams=new URLSearchParams(window.location.search);return urlParams.get('event_id');},[]);const sendRating=useCallback(async stars=>{if(!widgetApi){setFeedback('API не готов');return;}const eventId=getEventId();if(!eventId){setFeedback('Локальное тестирование - реакция не отправлена');return;}setIsSubmitting(true);setFeedback('Отправляем оценку...');try{await widgetApi.sendEvent('m.reaction',{'m.relates_to':{rel_type:'m.annotation',event_id:eventId,key:`rating:${stars}`}});setFeedback(`Спасибо! Вы поставили ${stars} ${stars===1?'звезду':stars<5?'звезды':'звёзд'}`);}catch(error){console.error('Ошибка отправки реакции:',error);setFeedback('Ошибка при отправке оценки');}finally{setIsSubmitting(false);}},[widgetApi,getEventId]);const handleStarClick=useCallback(stars=>{if(isSubmitting)return;setRating(stars);sendRating(stars);},[sendRating,isSubmitting]);const handleStarHover=useCallback(stars=>{if(!isSubmitting){setHoverRating(stars);}},[isSubmitting]);const handleMouseLeave=useCallback(()=>{setHoverRating(0);},[]);// Проверяем наличие event_id при загрузке\nuseEffect(()=>{const eventId=getEventId();if(!eventId){setFeedback('Режим предварительного просмотра');}},[getEventId]);const renderStars=()=>{const stars=[];const displayRating=hoverRating||rating;for(let i=1;i<=5;i++){stars.push(/*#__PURE__*/_jsx(\"span\",{className:`star ${i<=displayRating?'active':''}`,onClick:()=>handleStarClick(i),onMouseEnter:()=>handleStarHover(i),style:{cursor:isSubmitting?'not-allowed':'pointer',opacity:isSubmitting?0.6:1},children:\"\\u2605\"},i));}return stars;};return/*#__PURE__*/_jsxs(\"div\",{className:\"rating-widget\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"rating-title\",children:\"\\u041E\\u0446\\u0435\\u043D\\u0438\\u0442\\u0435 \\u043E\\u0442\\u0432\\u0435\\u0442 \\u0431\\u043E\\u0442\\u0430\"}),/*#__PURE__*/_jsx(\"div\",{className:\"stars-container\",onMouseLeave:handleMouseLeave,children:renderStars()}),/*#__PURE__*/_jsx(\"div\",{className:\"rating-feedback\",children:feedback})]});};export default RatingWidget;","map":{"version":3,"names":["React","useState","useCallback","useEffect","WidgetApi","jsx","_jsx","jsxs","_jsxs","RatingWidget","rating","setRating","hoverRating","setHoverRating","feedback","setFeedback","isSubmitting","setIsSubmitting","widgetApi","setWidgetApi","api","start","sendContentLoaded","e","console","log","requestCapabilities","getEventId","urlParams","URLSearchParams","window","location","search","get","sendRating","stars","eventId","sendEvent","rel_type","event_id","key","error","handleStarClick","handleStarHover","handleMouseLeave","renderStars","displayRating","i","push","className","onClick","onMouseEnter","style","cursor","opacity","children","onMouseLeave"],"sources":["C:/Users/pilat/Documents/Knwlab/matrix-bot-widget/src/components/RatingWidget.js"],"sourcesContent":["import React, { useState, useCallback, useEffect } from 'react';\r\nimport { WidgetApi } from 'matrix-widget-api';\r\n\r\nconst RatingWidget = () => {\r\n  const [rating, setRating] = useState(0);\r\n  const [hoverRating, setHoverRating] = useState(0);\r\n  const [feedback, setFeedback] = useState('');\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [widgetApi, setWidgetApi] = useState(null);\r\n\r\n  // Инициализируем Widget API\r\n  useEffect(() => {\r\n    const api = new WidgetApi();\r\n    api.start();\r\n    \r\n    try {\r\n      api.sendContentLoaded();\r\n    } catch (e) {\r\n      console.log('Локальное тестирование - sendContentLoaded не требуется');\r\n    }\r\n\r\n    try {\r\n      api.requestCapabilities([\r\n        'org.matrix.msc2762.send_event.m.reaction',\r\n        'org.matrix.msc2762.receive_event',\r\n      ]);\r\n    } catch (e) {\r\n      console.log('Локальное тестирование - capabilities не требуются');\r\n    }\r\n\r\n    setWidgetApi(api);\r\n  }, []);\r\n\r\n  // Получаем event_id из URL параметров\r\n  const getEventId = useCallback(() => {\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    return urlParams.get('event_id');\r\n  }, []);\r\n\r\n  const sendRating = useCallback(async (stars) => {\r\n    if (!widgetApi) {\r\n      setFeedback('API не готов');\r\n      return;\r\n    }\r\n\r\n    const eventId = getEventId();\r\n    if (!eventId) {\r\n      setFeedback('Локальное тестирование - реакция не отправлена');\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n    setFeedback('Отправляем оценку...');\r\n\r\n    try {\r\n      await widgetApi.sendEvent('m.reaction', {\r\n        'm.relates_to': {\r\n          rel_type: 'm.annotation',\r\n          event_id: eventId,\r\n          key: `rating:${stars}`\r\n        }\r\n      });\r\n      \r\n      setFeedback(`Спасибо! Вы поставили ${stars} ${stars === 1 ? 'звезду' : stars < 5 ? 'звезды' : 'звёзд'}`);\r\n    } catch (error) {\r\n      console.error('Ошибка отправки реакции:', error);\r\n      setFeedback('Ошибка при отправке оценки');\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  }, [widgetApi, getEventId]);\r\n\r\n  const handleStarClick = useCallback((stars) => {\r\n    if (isSubmitting) return;\r\n    \r\n    setRating(stars);\r\n    sendRating(stars);\r\n  }, [sendRating, isSubmitting]);\r\n\r\n  const handleStarHover = useCallback((stars) => {\r\n    if (!isSubmitting) {\r\n      setHoverRating(stars);\r\n    }\r\n  }, [isSubmitting]);\r\n\r\n  const handleMouseLeave = useCallback(() => {\r\n    setHoverRating(0);\r\n  }, []);\r\n\r\n  // Проверяем наличие event_id при загрузке\r\n  useEffect(() => {\r\n    const eventId = getEventId();\r\n    if (!eventId) {\r\n      setFeedback('Режим предварительного просмотра');\r\n    }\r\n  }, [getEventId]);\r\n\r\n  const renderStars = () => {\r\n    const stars = [];\r\n    const displayRating = hoverRating || rating;\r\n\r\n    for (let i = 1; i <= 5; i++) {\r\n      stars.push(\r\n        <span\r\n          key={i}\r\n          className={`star ${i <= displayRating ? 'active' : ''}`}\r\n          onClick={() => handleStarClick(i)}\r\n          onMouseEnter={() => handleStarHover(i)}\r\n          style={{ \r\n            cursor: isSubmitting ? 'not-allowed' : 'pointer',\r\n            opacity: isSubmitting ? 0.6 : 1\r\n          }}\r\n        >\r\n          ★\r\n        </span>\r\n      );\r\n    }\r\n\r\n    return stars;\r\n  };\r\n\r\n  return (\r\n    <div className=\"rating-widget\">\r\n      <h3 className=\"rating-title\">Оцените ответ бота</h3>\r\n      <div \r\n        className=\"stars-container\" \r\n        onMouseLeave={handleMouseLeave}\r\n      >\r\n        {renderStars()}\r\n      </div>\r\n      <div className=\"rating-feedback\">\r\n        {feedback}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default RatingWidget;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}